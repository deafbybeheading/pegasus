<?xml version="1.0" encoding="utf-8"?>
<mx:WindowedApplication xmlns:mx="http://www.adobe.com/2006/mxml" layout="vertical"
    xmlns:debug="org.postgresql.debug.*">
<mx:Script>
    <![CDATA[
        import org.postgresql.db.IResultHandler;
        import org.postgresql.db.SimpleResultHandler;
        import org.postgresql.db.SimpleQueryHandler;
        import org.postgresql.db.IColumn;
        import org.postgresql.codec.decode.FloatOut;
        import org.postgresql.codec.decode.TextOut;
        import org.postgresql.event.ResultEvent;
        import org.postgresql.event.ResultEvent;
        import org.postgresql.db.QueryHandlerFactory;
        import org.postgresql.db.Column;
        import org.postgresql.event.MetadataEvent;
        import org.postgresql.event.ResultSetEvent;
        import org.postgresql.util.DateFormatter;
        import org.postgresql.util.assert;
        import org.postgresql.log.Log;
        import org.postgresql.log.LogLevel;
        import org.postgresql.log.TraceTarget;
        import org.postgresql.io.SocketDataStreamFactory;
        import org.postgresql.febe.MessageBrokerFactory;
        import org.postgresql.Oid;
        import org.postgresql.codec.decode.IntOut;
        import org.postgresql.codec.decode.DateOut;
        import org.postgresql.codec.CodecFactory;
        import mx.controls.Alert;
        import org.postgresql.febe.FEBEConnection;
        import org.postgresql.db.Connection;
        import org.postgresql.febe.message.Query;

        import org.postgresql.io.SocketDataStream;
        import org.postgresql.febe.message.StartupMessage;
        import org.postgresql.febe.MessageBroker;
    
        private var str:SocketDataStream;
    
        private function handleClick(e:Event):void {
            trace('connecting');
            if (Capabilities.isDebugger) {
                var logTarget:TraceTarget = new TraceTarget();
                logTarget.format = "%d %t [%l] %c - %m (%n): %s";
                Log.addTarget(logTarget, LogLevel.DEBUG);
            }

            var brokerFactory:MessageBrokerFactory =
                new MessageBrokerFactory(
                    new SocketDataStreamFactory('localhost', 5432));
            var params:Object = {
                user: 'maciek',
                database: 'maciek'
            };
            var codecFactory:CodecFactory = new CodecFactory();
            codecFactory.registerDecoder(Oid.INT2, int, new IntOut());
            codecFactory.registerDecoder(Oid.INT4, int, new IntOut());
            codecFactory.registerDecoder(Oid.FLOAT4, int, new FloatOut());
            codecFactory.registerDecoder(Oid.FLOAT8, int, new FloatOut());
            codecFactory.registerDecoder(Oid.TIMESTAMP, Date, new DateOut());
            codecFactory.registerDecoder(Oid.TIMESTAMPTZ, Date, new DateOut());
            codecFactory.registerDecoder(Oid.BPCHAR, String, new TextOut());
            codecFactory.registerDecoder(Oid.VARCHAR, String, new TextOut());
            codecFactory.registerDecoder(Oid.CHAR, String, new TextOut());
            codecFactory.registerDecoder(Oid.TEXT, String, new TextOut());
            var febeConn:FEBEConnection = new FEBEConnection(params, 'foo', brokerFactory);
            var handlerFactory:QueryHandlerFactory = new QueryHandlerFactory(codecFactory);
            var traceHandler:IResultHandler = new SimpleResultHandler(handleData, handleResult);
            var conn:Connection = new Connection(febeConn, handlerFactory);
            conn.execute("select now()::timestamp as t1, now()::timestamptz as t2, " +
                "'foo'::char(3) as txt1, 'foo'::varchar(3) as txt2, 'foo'::text as txt3, " +
                "1.2::float4 as float4, 1.3::float8 as float8", traceHandler);
            conn.execute("drop table if exists test", traceHandler);
            conn.execute("create table test(a int)", traceHandler);
            conn.execute("insert into test(a) (values(1),(2),(3))", traceHandler);

            var closeFn:Function = function(command:String, affectedRows:int):void {
                handleResult(command, affectedRows);
                conn.close();
            };
            var closeHandler:IResultHandler = new SimpleResultHandler(handleData, closeFn);
            conn.execute("select * from test", closeHandler); 
            
        }
        private function handleResult(command:String, affectedRows:int):void {
            trace(command, affectedRows);
        }

        private function handleData(columns:Array, data:Array):void {
            trace('received metadata:');
            for each (var col:IColumn in columns) {
                trace('\t', col.name, '\t', col.type);
            }
            trace('received data');
            for each (var item:Object in data) {
                for (var colName:String in item) {
                    trace('\t', colName, '\t', item[colName]);
                }
            }
        }

    ]]>
</mx:Script>
    <mx:Button label="connect" click="handleClick(event)"/>
</mx:WindowedApplication>
